<video id="v" autoplay playsinline></video>
<script src="/socket.io/socket.io.js"></script>
<script>
const socket = io();
let deviceId, pc;

function connect(id){
  deviceId = id;
  pc = new RTCPeerConnection({
    iceServers:[{urls:"stun:stun.l.google.com:19302"}]
  });

  pc.ontrack = e => v.srcObject = e.streams[0];

  pc.onicecandidate = e => {
    if(e.candidate){
      socket.emit("ice", {
        device_id: deviceId,
        candidate: e.candidate.candidate,
        sdpMid: e.candidate.sdpMid,
        sdpMLineIndex: e.candidate.sdpMLineIndex
      });
    }
  };

  socket.emit("start", deviceId);
}

socket.on("offer", async d => {
  await pc.setRemoteDescription({type:"offer", sdp:d.sdp});
  const ans = await pc.createAnswer();
  await pc.setLocalDescription(ans);
  socket.emit("answer", {device_id:deviceId, sdp:ans.sdp});
});

socket.on("ice", d => {
  pc.addIceCandidate(new RTCIceCandidate(d));
});

v.onclick = e => {
  socket.emit("control", {
    device_id: deviceId,
    type:"tap",
    x:e.offsetX,
    y:e.offsetY
  });
};
</script>
