<!DOCTYPE html>
<html>
<head>
    <title>Remote Control Dashboard</title>
    <link rel="stylesheet" href="style.css">
</head>
<body>
    <div class="container">
        <h1>üì± Remote Control Dashboard</h1>
        
        <div class="devices-section">
            <h2>Registered Devices</h2>
            <div id="devicesList" class="devices-grid"></div>
        </div>

        <div class="device-view" id="deviceView" style="display:none;">
            <div class="device-header">
                <h2 id="deviceTitle">Select Device</h2>
                <button onclick="backToList()" class="back-btn">‚Üê Back</button>
            </div>
            <div id="screenContainer" class="screen-container">
                <canvas id="screenCanvas" class="screen-canvas"></canvas>
                <div id="uiOverlay" class="ui-overlay"></div>
            </div>
            <div class="controls">
                <button onclick="performSwipe()">Swipe Test</button>
                <button onclick="toggleLayout()">Toggle Layout</button>
            </div>
        </div>
    </div>

    <script>
        const ws = new WebSocket('ws://localhost:8080');
        let currentDeviceId = null;
        let layouts = {};
        let showLayoutOverlay = true;

        ws.onmessage = (event) => {
            const data = JSON.parse(event.data);
            if (data.type === 'LAYOUT_UPDATE') {
                layouts[data.deviceId] = data.layout;
                if (currentDeviceId === data.deviceId) {
                    renderLayoutOverlay(data.layout);
                }
                updateDevicesList();
            }
        };

        function updateDevicesList() {
            const devicesList = document.getElementById('devicesList');
            devicesList.innerHTML = '';
            
            Object.keys(layouts).forEach(deviceId => {
                const deviceDiv = document.createElement('div');
                deviceDiv.className = 'device-item';
                deviceDiv.innerHTML = `
                    <div class="device-id">${deviceId.slice(0,16)}...</div>
                    <div class="device-status">Online</div>
                    <button onclick="openDevice('${deviceId}')" class="control-btn">Control</button>
                `;
                devicesList.appendChild(deviceDiv);
            });
        }

        function openDevice(deviceId) {
            currentDeviceId = deviceId;
            document.getElementById('devicesList').style.display = 'none';
            document.getElementById('deviceView').style.display = 'block';
            document.getElementById('deviceTitle').textContent = `Device: ${deviceId}`;
            renderLayoutOverlay(layouts[deviceId]);
        }

        function backToList() {
            document.getElementById('devicesList').style.display = 'grid';
            document.getElementById('deviceView').style.display = 'none';
            currentDeviceId = null;
        }

        function renderLayoutOverlay(layout) {
            const overlay = document.getElementById('uiOverlay');
            overlay.innerHTML = '';
            
            if (!showLayoutOverlay || !layout) return;

            function renderNode(node, parentElement) {
                const div = document.createElement('div');
                const bounds = node.bounds;
                const screenRect = document.getElementById('screenContainer').getBoundingClientRect();
                
                div.style.position = 'absolute';
                div.style.left = `${(bounds[0] / 1080) * 100}%`;
                div.style.top = `${(bounds[1] / 1920) * 100}%`;
                div.style.width = `${((bounds[2] - bounds[0]) / 1080) * 100}%`;
                div.style.height = `${((bounds[3] - bounds[1]) / 1920) * 100}%`;
                div.style.border = '1px solid rgba(0,255,0,0.3)';
                div.style.backgroundColor = 'rgba(0,255,0,0.1)';
                div.style.cursor = 'pointer';
                div.title = node.text || node.class;
                
                div.onclick = () => sendTouch(bounds[0]/1080*screenRect.width, bounds[1]/1920*screenRect.height);
                
                parentElement.appendChild(div);
                
                if (node.children) {
                    node.children.forEach(child => renderNode(child, div));
                }
            }
            
            renderNode(layout, overlay);
        }

        function sendTouch(x, y) {
            if (currentDeviceId) {
                ws.send(JSON.stringify({
                    type: 'TOUCH',
                    deviceId: currentDeviceId,
                    x: x,
                    y: y,
                    action: 'DOWN'
                }));
            }
        }

        function performSwipe() {
            if (currentDeviceId) {
                ws.send(JSON.stringify({
                    type: 'SWIPE',
                    deviceId: currentDeviceId,
                    startX: 100,
                    startY: 100,
                    endX: 500,
                    endY: 500,
                    duration: 500
                }));
            }
        }

        function toggleLayout() {
            showLayoutOverlay = !showLayoutOverlay;
            renderLayoutOverlay(layouts[currentDeviceId]);
        }

        // Touch events on canvas
        document.getElementById('screenCanvas').addEventListener('click', (e) => {
            const rect = e.target.getBoundingClientRect();
            const x = e.clientX - rect.left;
            const y = e.clientY - rect.top;
            sendTouch(x, y);
        });

        updateDevicesList();
    </script>
</body>
</html>
