<!DOCTYPE html>
<html>
<head>
    <title>Android Layout Spy</title>
    <style>
        body { margin: 0; font-family: Arial; background: #1a1a1a; color: white; }
        #screen { 
            width: 100vw; 
            height: 100vh; 
            position: relative; 
            background: #000; 
            overflow: hidden;
            cursor: pointer;
        }
        .element {
            position: absolute;
            border: 1px solid rgba(255,255,255,0.3);
            background: rgba(0,255,0,0.1);
            cursor: pointer;
            font-size: 10px;
            padding: 2px;
            box-sizing: border-box;
            transition: all 0.2s;
        }
        .element:hover {
            background: rgba(0,255,255,0.3) !important;
            border-color: #00ffff;
            z-index: 1000;
        }
        .element.clickable { 
            border-color: #ff4444 !important; 
            background: rgba(255,68,68,0.2);
        }
        .element.button { background: rgba(255,165,0,0.3); }
        .element.text { background: rgba(0,255,0,0.2); }
        .element.scrollable { border-style: dashed; }
        .info-panel {
            position: fixed;
            top: 10px;
            right: 10px;
            background: rgba(0,0,0,0.8);
            padding: 10px;
            border-radius: 5px;
            font-size: 12px;
        }
        #controls { 
            position: fixed; 
            bottom: 10px; 
            left: 10px; 
            background: rgba(0,0,0,0.8);
            padding: 10px;
            border-radius: 5px;
        }
        button { 
            background: #007acc; 
            color: white; 
            border: none; 
            padding: 8px 16px; 
            margin: 2px; 
            border-radius: 4px; 
            cursor: pointer;
        }
        button:hover { background: #005a99; }
    </style>
</head>
<body>
    <div id="screen"></div>
    <div class="info-panel">
        <div id="deviceInfo">Waiting for device...</div>
        <div id="stats">Elements: 0</div>
    </div>
    <div id="controls">
        <button onclick="performBack()">‚Üê Back</button>
        <button onclick="toggleHighlight()">Highlight</button>
        <span id="mousePos">X:0 Y:0</span>
    </div>

    <script src="/socket.io/socket.io.js"></script>
    <script>
        const socket = io();
        const screen = document.getElementById('screen');
        const deviceInfo = document.getElementById('deviceInfo');
        const stats = document.getElementById('stats');
        const mousePos = document.getElementById('mousePos');
        
        let elements = [];
        let screenScale = 1;
        let highlightMode = false;
        let selectedElement = null;

        // Screen resize
        function updateScreenScale() {
            const aspect = window.innerWidth / window.innerHeight;
            screenScale = Math.min(window.innerWidth / 1080, window.innerHeight / 1920);
            screen.style.transform = `scale(${screenScale})`;
            screen.style.transformOrigin = 'top left';
        }
        window.addEventListener('resize', updateScreenScale);
        updateScreenScale();

        // Mouse position tracking
        screen.addEventListener('mousemove', (e) => {
            const rect = screen.getBoundingClientRect();
            const x = (e.clientX - rect.left) / screenScale;
            const y = (e.clientY - rect.top) / screenScale;
            mousePos.textContent = `X:${Math.round(x)} Y:${Math.round(y)}`;
        });

        // Layout rendering
        socket.on('layout-update', (data) => {
            deviceInfo.innerHTML = `üì± ${data.deviceId}<br>Screen: ${data.screen.width}x${data.screen.height}`;
            stats.textContent = `Elements: ${data.elements.length}`;
            
            // Clear previous elements
            elements.forEach(el => el.remove());
            elements = [];
            
            // Render new elements
            data.elements.forEach((el, index) => {
                const div = document.createElement('div');
                const bounds = el.bounds;
                
                // Scale coordinates
                div.style.left = `${bounds[0] * screenScale}px`;
                div.style.top = `${bounds[1] * screenScale}px`;
                div.style.width = `${(bounds[2] - bounds[0]) * screenScale}px`;
                div.style.height = `${(bounds[3] - bounds[1]) * screenScale}px`;
                
                // Classes and styles
                div.className = 'element';
                if (el.clickable) div.classList.add('clickable');
                if (el.className?.includes('Button')) div.classList.add('button');
                if (el.scrollable) div.classList.add('scrollable');
                
                // Tooltip with full info
                div.title = `ID:${el.id}\nClass:${el.className}\nText:"${el.text}"\nDesc:"${el.contentDesc}"\nChildren:${el.children}`;
                
                // Click handler
                div.onclick = (e) => {
                    e.stopPropagation();
                    selectElement(el, div);
                    performTap(bounds[0] + (bounds[2]-bounds[0])/2, bounds[1] + (bounds[3]-bounds[1])/2);
                };
                
                screen.appendChild(div);
                elements.push(div);
            });
        });

        // Element selection
        function selectElement(el, div) {
            if (selectedElement) selectedElement.style.boxShadow = '';
            selectedElement = div;
            if (selectedElement) {
                selectedElement.style.boxShadow = '0 0 20px #00ff00';
                console.log('Selected:', el);
            }
        }

        // Screen tap (anywhere)
        screen.onclick = (e) => {
            if (!highlightMode) {
                const rect = screen.getBoundingClientRect();
                const x = (e.clientX - rect.left) / screenScale;
                const y = (e.clientY - rect.top) / screenScale;
                performTap(x, y);
            }
        };

        // Control functions
        function performTap(x, y) {
            socket.emit('control', {
                action: 'tap',
                x: x,
                y: y
            });
            console.log(`üëÜ Tap at ${Math.round(x)}, ${Math.round(y)}`);
        }

        function performSwipe(sx, sy, ex, ey) {
            socket.emit('control', {
                action: 'swipe',
                startX: sx,
                startY: sy,
                endX: ex,
                endY: ey
            });
        }

        function performBack() {
            socket.emit('control', { action: 'back' });
            console.log('‚Üê Back pressed');
        }

        function toggleHighlight() {
            highlightMode = !highlightMode;
            screen.style.cursor = highlightMode ? 'crosshair' : 'pointer';
        }

        // Device list
        socket.on('device-list', (devices) => {
            console.log('Available devices:', devices);
        });
    </script>
</body>
</html>
