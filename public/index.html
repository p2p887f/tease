<!DOCTYPE html>
<html>
<head>
    <title>üì± Remote Control</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <script src="/socket.io/socket.io.js"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { 
            font-family: 'Segoe UI', sans-serif; 
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white; 
            overflow: hidden;
        }
        #devices { 
            padding: 40px; 
            max-height: 100vh; 
            overflow-y: auto;
        }
        .device-btn { 
            display: block; 
            width: 100%; 
            padding: 20px; 
            margin: 10px 0; 
            background: rgba(255,255,255,0.1); 
            border: none; 
            border-radius: 15px; 
            color: white; 
            font-size: 18px; 
            cursor: pointer; 
            backdrop-filter: blur(10px);
            transition: all 0.3s;
        }
        .device-btn:hover { transform: scale(1.02); background: rgba(255,255,255,0.2); }
        .device-btn.online { box-shadow: 0 0 20px #00ff88; }
        .device-btn.offline { opacity: 0.5; }
        
        #control-panel { 
            position: fixed; 
            top: 0; left: 0; 
            width: 100vw; height: 100vh; 
            display: none;
        }
        #screen { 
            width: 100%; height: 100%; 
            background: #000; 
            cursor: crosshair; 
            touch-action: none;
        }
        .controls {
            position: fixed; top: 20px; right: 20px; z-index: 100;
            display: flex; gap: 10px; flex-direction: column;
        }
        .btn { 
            padding: 15px 25px; 
            background: #ff4757; 
            color: white; 
            border: none; 
            border-radius: 25px; 
            font-size: 16px; 
            cursor: pointer;
            box-shadow: 0 5px 15px rgba(0,0,0,0.3);
        }
        .btn:hover { transform: translateY(-2px); }
    </style>
</head>
<body>
    <div id="devices">
        <h1 style="margin-bottom: 30px; font-size: 2.5em;">üì± Connected Devices</h1>
        <div id="deviceList"></div>
        <button class="btn" onclick="location.reload()" style="width:100%; margin-top:20px;">üîÑ Refresh</button>
    </div>
    
    <div id="control-panel">
        <div class="controls">
            <button class="btn" onclick="goBack()">‚Üê Back</button>
            <button class="btn" onclick="home()">üè† Home</button>
            <button class="btn" onclick="recent()">‚Ü©Ô∏è Recent</button>
            <button class="btn" onclick="showDevices()">üìã Devices</button>
        </div>
        <canvas id="screen"></canvas>
    </div>

    <script>
        const socket = io();
        let currentDevice = null;
        let canvas, ctx;
        let lastLayout = null;
        
        // Load devices
        function loadDevices() {
            fetch('/devices')
                .then(r => r.json())
                .then(devices => {
                    document.getElementById('deviceList').innerHTML = 
                        devices.map(d => `
                            <button class="device-btn ${d.online ? 'online' : 'offline'}" 
                                    onclick="controlDevice('${d.deviceId}')">
                                <strong>${d.model || d.deviceId}</strong><br>
                                ${d.brand} ‚Ä¢ Android ${d.version} ‚Ä¢ ${d.online ? 'üü¢ ONLINE' : 'üî¥ OFFLINE'}
                            </button>
                        `).join('');
                });
        }
        
        function controlDevice(deviceId) {
            currentDevice = deviceId;
            document.getElementById('devices').style.display = 'none';
            document.getElementById('control-panel').style.display = 'block';
            
            canvas = document.getElementById('screen');
            ctx = canvas.getContext('2d');
            canvas.width = window.innerWidth;
            canvas.height = window.innerHeight;
            
            // Join device room
            socket.emit('join_device', deviceId);
        }
        
        // Screen rendering
        socket.on('layout', (layout) => {
            if (currentDevice) {
                lastLayout = JSON.parse(layout);
                renderScreen();
            }
        });
        
        function renderScreen() {
            if (!lastLayout || !canvas) return;
            
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            const scaleX = canvas.width / 1080;
            const scaleY = canvas.height / 1920;
            drawNode(lastLayout, 0, 0, scaleX, scaleY);
        }
        
        function drawNode(node, offsetX, offsetY, scaleX, scaleY) {
            if (!node.boundsInScreen) return;
            
            const rect = {
                x: node.boundsInScreen.left * scaleX + offsetX,
                y: node.boundsInScreen.top * scaleY + offsetY,
                w: (node.boundsInScreen.right - node.boundsInScreen.left) * scaleX,
                h: (node.boundsInScreen.bottom - node.boundsInScreen.top) * scaleY
            };
            
            // Draw bounds
            ctx.strokeStyle = node.clickable ? '#00ff41' : '#444';
            ctx.lineWidth = 1;
            ctx.strokeRect(rect.x, rect.y, rect.w, rect.h);
            
            // Text label
            if (node.text && node.text.length > 0) {
                ctx.fillStyle = '#fff';
                ctx.font = `${Math.min(14, rect.h * 0.6)}px Arial`;
                ctx.fillText(node.text.toString().substring(0, 15), rect.x, rect.y - 5);
            }
            
            // Children
            if (node.children) {
                node.children.forEach(child => drawNode(child, offsetX, offsetY, scaleX, scaleY));
            }
        }
        
        // Input handling
        let dragStart = {x: 0, y: 0};
        
        ['mousedown', 'touchstart'].forEach(evt => {
            canvas.addEventListener(evt, (e) => {
                e.preventDefault();
                const rect = canvas.getBoundingClientRect();
                const clientX = evt.includes('mouse') ? e.clientX : e.touches[0].clientX;
                const clientY = evt.includes('mouse') ? e.clientY : e.touches[0].clientY;
                
                dragStart = {
                    x: (clientX - rect.left) * (1080 / canvas.width),
                    y: (clientY - rect.top) * (1920 / canvas.height)
                };
            });
        });
        
        ['mouseup', 'touchend'].forEach(evt => {
            canvas.addEventListener(evt, (e) => {
                e.preventDefault();
                if (!currentDevice || !dragStart) return;
                
                const rect = canvas.getBoundingClientRect();
                const clientX = evt.includes('mouse') ? e.clientX : e.changedTouches[0].clientX;
                const clientY = evt.includes('mouse') ? e.clientY : e.changedTouches[0].clientY;
                
                const endX = (clientX - rect.left) * (1080 / canvas.width);
                const endY = (clientY - rect.top) * (1920 / canvas.height);
                
                const dist = Math.hypot(endX - dragStart.x, endY - dragStart.y);
                
                if (dist < 30) {
                    // Tap
                    fetch(`/control/${currentDevice}/tap`, {
                        method: 'POST',
                        headers: {'Content-Type': 'application/json'},
                        body: JSON.stringify({x: Math.round(dragStart.x), y: Math.round(dragStart.y)})
                    });
                } else {
                    // Swipe
                    fetch(`/control/${currentDevice}/swipe`, {
                        method: 'POST',
                        headers: {'Content-Type': 'application/json'},
                        body: JSON.stringify({
                            x1: Math.round(dragStart.x), y1: Math.round(dragStart.y),
                            x2: Math.round(endX), y2: Math.round(endY)
                        })
                    });
                }
                dragStart = null;
            });
        });
        
        // Control functions
        function goBack() {
            if (currentDevice) {
                fetch(`/control/${currentDevice}/back`, {method: 'POST'});
            }
        }
        
        function home() {
            // Home gesture
            fetch(`/control/${currentDevice}/home`, {method: 'POST'});
        }
        
        function recent() {
            // Recent apps
            fetch(`/control/${currentDevice}/recent`, {method: 'POST'});
        }
        
        function showDevices() {
            document.getElementById('control-panel').style.display = 'none';
            document.getElementById('devices').style.display = 'block';
            currentDevice = null;
            loadDevices();
        }
        
        // Auto refresh devices every 10s
        setInterval(loadDevices, 10000);
        loadDevices(); // Initial load
    </script>
</body>
</html>
